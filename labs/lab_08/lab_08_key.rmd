---
title: "lab_09"
author: "derek willis"
date: "10/26/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## You will need

* A Census API key

## Load libraries and establish settings

**Task** Create a codeblock and load appropriate packages and settings for this lab. We'll be making some charts and using Census data.

```{r}
# Turn off scientific notation
options(scipen=999)

# Load the tidyverse.
library(tidyverse)
library(tidycensus)
library(janitor)

# Establish API Key for Census
census_api_key("549950d36c22ff16455fe196bbbd01d63cfbe6cf")

```

## Load data

**Task** Create a codeblock and load the following data from the data folder:

* Maryland active registered voters - `md_active_voters.csv`
* Maryland absentee ballots sent and returned - `md_absentee_ballots.csv`

You may want to clean up the column names and standardize the names of counties so that they appear identical in the two dataframes.


```{r}
md_active_voters <- read_csv("data/md_active_voters.csv")
md_absentee_ballots <- read_csv("data/md_absentee_ballots.csv") %>% clean_names() %>% mutate(county_name = str_to_title(county_name))
```

## Questions 

**Q1.** Which county has the highest percentage of total absentee ballots returned of total ballots sent? Make a bar chart of the top 10 counties. Your bar chart must have:

* A clear title that states the main idea/finding
* Good labels for the x & y axis and a caption for the source, which is the Maryland State Board of Elections
* Readable bars - the values shouldn't be overlapping

**A1.** 

```{r}

# Calculate the percentage
md_absentee_ballots <- md_absentee_ballots %>%
  mutate(pct_returned = total_received/total_sent*100) %>% 
  arrange(desc(pct_returned))

# Plot the data.  Use geom_line to draw the line, geom_point to add points, geom_text to add labels.  Use scale_x_date to set breaks at 1 day. 
md_absentee_ballots %>%
  head(10) %>% 
  ggplot() + 
  geom_bar(aes(x=reorder(county_name,pct_returned), weight=pct_returned)) + 
  coord_flip() +
  labs(
    title="Smallest Maryland Counties Returning More Absentee Ballots",
    x = "percentage of ballots returned",
    y = "county",
    caption = "source: Maryland State Board of Elections"
  )

```

**Q2.** What are the top 10 states that got the most PPP loans per 100,000 people? You MUST do the following things when answering this question:

* Make a codeblock below to write your code in.
* Use the csv of total PPP loans by state in the data folder (state_ppp_all) as your source for total PPP loans by state.  
* Use the tidycensus API to get a table of total population by state from the American Community Survey (ACS). To do this, you'll use use the alphanumeric variable for total population, which has the following "label" and "concept": "Estimate!!Total:" and "SEX BY AGE".  
* Use ggplot to make a horizontal bar chart that shows the top 10 states, with the length of the bar determined by the state's total PPP loans per 100,000 people. Give it an appropriate title, source, and x and y axis titles. 
* Make the bars on the chart blue! I didn't show you how to do this in the prelab, so do some web sleuthing to figure it out.  

**A2.** See the chart.  South Dakota is first through Montana, 10. 
```{r}

# Load ACS5 vairables to determine the varialbe number for total population.  Examine in the dataframe viewer. 
variables <- load_variables(2019, "acs5", cache=TRUE)

# Load a table of state population using get_acs(), and clean it up to keep only state name and total ppulation
state_total_population <- get_acs(geography='state', variables=c(total_population='B01001_001')) %>%
  rename(total_population = estimate) %>%
  clean_names() %>%
  select(name, total_population)

# Read in the csv of total ppp loans by state.  It has a problem, though, that prevents proper joining in the next step.  North and South Dakota are abbreviated in this data set, but not the population dataset.  Fix this using mutate and case when. 
state_total_loans <- read_csv("data/state_ppp_all.csv") %>%
    mutate(state = case_when(
    state == "N Dakota" ~ "North Dakota",
    state == "S Dakota" ~ "South Dakota",
    TRUE ~ state
  ))

# Join state total loans to population, on state / name, and then calculate loans per 100k.  Sort and keep top 10 records. 
state_total_loans_population <- state_total_loans %>%
  inner_join(state_total_population, by=c("state" = "name")) %>%
  mutate(loans_per_100k = total_ppp_loans/total_population*100000) %>%
  arrange(desc(loans_per_100k)) %>%
  head(10)

# Make a ggplot bar chart with geom_bar.  Use "fill" inside geom_bar to make bars blue.  Use coord_flip to make horizontal.  Add labels. 
state_total_loans_population %>%
  ggplot() +
  geom_bar(aes(x=reorder(state,loans_per_100k), weight=loans_per_100k), fill = "blue") +
  coord_flip() + 
  labs(
    title="Top 10 states by ppp loans per 100,000 people",
    x = "State",
    y = "Loans per 100K",
    caption = "source: SBA PPP loan; U.S. Census."
    
  ) 

```

**Q3.**  A scatterplot is a type of chart that helps us see relationships between two variables. One variable goes on the x axis, the other on the y axis.  For each row/observation in our data, a scatterplot puts a circle (or a "point") where the two variables intersect on a grid. 

Statisticians use scatterplots to show graphically whether one variable is correlated -- related, in a statistical sense -- with another variable.  A classic example is the [relationship between ice cream sales and temperature](https://www.mathsisfun.com/data/scatter-xy-plots.html).  The scatterplot below -- press play to load the image -- shows that relationship, that an increase in temperature is associated with an increase in ice cream sales. When it's 12C, sales are 200 dollars, and when it's hotter, 25C, sales are 600 dollars.

```{r}
knitr::include_graphics(rep("images/chart_2.png"))
```

We're going to use a scatterplot a little differently, to get a visual sense of two key variables: the amount of an approved PPP loan, and the amount that was later forgiven. We'll use it to answer some questions in a broad sense, about loan forgiveness.  This is just a jumping off point for further exploration. 

Our questions include: Were there a lot of people who had their loans fully forgiven?  Were there a lot of people who didn't have their loans forgiven? Were there a lot of people who had some of the loan forgiven? 
To answer those questions, do the following:

1. Start with the a subset of the WV ppp loan data we loaded earlier.
2. Filter the data to examine only those loans less than $25,000.
3. There are a bunch of NAs in the forgiveness amount column, for the purposes of this assignment only, let's assume those are actually supposed to be 0. So make all the NAs 0. 
4. Make a scatterplot. I didn't show you how to do this, so look it up! 
5. In the answer space below, describe what you see and answer the questions posed above.  In a general sense, what do you think this means?  

**A3.**  This data shows that there were a lot of loans that a lot of loans were totally forgiven. Those are represented by the overlapping points running at a 45 degree angle from the bottom left to the top right of the graphic.  And there were a lot of loans that weren't forgiven at all.  That's represented by the overlapping points running in a straight line on the x axis (bottom left to bottom right).  And then there a smaller collection of loans in the middle space, that were partially forgiven. If you look closely, you'll see the traces of a broken line running parallell to the loans that were totally forgiven. Could this suggest that there's some formula the SBA used to determine forgiveness? Loans forgiven except for 10 percent, 20 percent, 30 percent. 

```{r}

# Load PPP loan data for WV
ppp_wv_loans <- read_rds("data/lab_09.rds")

# Filter to keep only loans less than $25K, use mutate, case when and is.na to convert all NAs to 0. 
ppp_wv_loans <- ppp_wv_loans %>%
  filter(amount < 25000) %>%
  mutate(forgiveness_amount = case_when(
    is.na(forgiveness_amount) ~ 0,
    TRUE ~ forgiveness_amount
  )) 

# Plot it using geom_point.
ppp_wv_loans %>%
  ggplot() +
  geom_point(aes(x=amount,y=forgiveness_amount)) 
```
